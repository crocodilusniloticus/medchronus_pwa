<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1", user-scalable="yes">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#283593">
    
    <title>MedChronos</title>
    
    <link rel="stylesheet" href="css/flatpickr.min.css?v=2.2.26">
    <link rel="stylesheet" href="css/airbnb.css?v=2.2.26">
    <link rel="stylesheet" href="styles-v2.2.26.css">
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js?v=2.2.26" async defer></script>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js?v=2.2.26"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <!-- CRITICAL FIX: Import Map for PWA Module Resolution -->
    <script type="importmap">
    {
      "imports": {
        "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
      }
    }
    </script>

    <style>
        .flatpickr-calendar { font-family: 'Inter', sans-serif; direction: rtl; }
        .flatpickr-month { direction: ltr; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-brand">
                <div class="logo-icon">‚öïÔ∏è</div>
                <h1>Med<strong>Chronos</strong></h1>
            </div>
            <div class="header-stats">
                <div id="streak-container" class="streak-badge" data-tooltip="Current Study Streak">
                    <span class="streak-icon">üî•</span>
                    <div class="streak-info">
                        <span id="streak-count">0</span>
                        <span class="streak-label">Day Streak</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <span id="sync-status" style="font-size: 0.8rem; font-weight: 600; color: var(--primary); margin-right: 10px; opacity: 0; transition: opacity 0.5s;"></span>

                <button id="sync-btn" class="icon-btn" aria-label="Sync" data-tooltip="Sync Google Calendar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h16"></path><path d="M3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M10 12h4"></path></svg>
                </button>
                
                <button id="help-btn" class="icon-btn" aria-label="Help" data-tooltip="User Manual">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </button>

                <button id="global-settings-btn" class="icon-btn" aria-label="Settings" data-tooltip="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <div class="dashboard-grid">
            <section class="card study-card">
                <div class="card-header">
                    <h3>Study Trend</h3>
                    <div class="chart-controls-group">
                        <div class="toggle-pill-container">
                            <button id="btn-pie-trend" class="toggle-pill active" style="width: 70px;">Trend</button>
                            <button id="btn-pie-total" class="toggle-pill" style="width: 70px;">Total</button>
                            <button id="btn-pie-today" class="toggle-pill" style="width: 70px;">Today</button>
                        </div>
                        <select id="trend-span-select" class="trend-select">
                            <option value="7">7 Days</option>
                            <option value="30">30 Days</option>
                        </select>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-header-row">
                        <div id="trend-stats-container" class="trend-stats-box">
                            <span id="trend-stats-value" class="stat-value">--</span>
                            <span id="trend-stats-status" class="stat-status"></span>
                        </div>
                    </div>
                    <div class="chart-content-area" style="position: relative; flex-grow: 1; width: 100%; min-height: 0;">
                        <div class="chart-container chart-clickable" id="time-chart" style="width: 100%; height: 100%;"></div>
                        <div id="pie-overlay" class="pie-center-text hidden">
                            <div id="pie-val" class="pie-val-text">0.0</div>
                            <div class="pie-label-text">HOURS</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card performance-card">
                <div class="card-header">
                    <h3>Performance</h3>
                    <div class="chart-controls-group"></div>
                </div>
                <div class="chart-wrapper">
                    <div class="chart-header-row"></div>
                    <div class="chart-container chart-clickable" id="score-chart"></div>
                </div>
            </section>

            <section class="card tasks-card">
                <div class="card-header">
                    <h3>Deadlines</h3>
                    <button id="btn-toggle-tasks" class="text-link-btn">Show Completed</button>
                </div>
                <div id="task-list" class="custom-scrollbar"></div>
            </section>

            <div class="left-stack">
                <section class="card calendar-card">
                    <div class="card-header compact-header">
                        <h3>Calendar</h3>
                        <button id="btn-calendar-today" class="text-link-btn">Today</button>
                    </div>
                    <div id="study-calendar"></div>
                </section>

                <section class="card score-card">
                    <div class="card-header compact-header"><h3>Log Score</h3></div>
                    <div class="score-grid">
                        <select id="scoreCourseSelect" class="modern-select"></select>
                        <input type="number" id="scoreInput" class="modern-input" min="0" max="100" placeholder="%">
                        <button id="logScoreButton" class="btn btn-primary">Log</button>
                    </div>
                    <textarea id="scoreNotes" class="modern-textarea" placeholder="Exam notes..." rows="1"></textarea>
                    <div id="scoreError" class="error-message"></div>
                </section>
            </div>

            <section class="card timer-card">
                <div class="card-header">
                    <h3>Active Session</h3>
                    <button id="btn-focus-mode" class="icon-btn focus-btn" data-tooltip="Enter Focus Mode">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                </div>
                <div class="timer-mode-switcher">
                    <button id="btn-timer-stopwatch" class="mode-tab active">Stopwatch</button>
                    <button id="btn-timer-pomodoro" class="mode-tab">Pomodoro</button>
                    <button id="btn-timer-countdown" class="mode-tab">Countdown</button>
                </div>
                <div class="timer-body">
                    <div id="quote-container" class="quote-container"></div>
                    <div id="stopwatch-panel" class="timer-panel">
                        <div class="input-group"><select id="courseSelect" class="modern-select large-text"></select></div>
                        <div class="timer-display-container"><div id="timerDisplay" class="main-timer-text">00:00:00</div></div>
                        <div class="timer-actions">
                            <button id="startButton" class="btn btn-primary btn-large">Start Session</button>
                            <button id="stopButton" class="btn btn-danger hidden" disabled>Stop</button>
                            <button id="resetButton" class="btn btn-ghost hidden" disabled>Reset</button> 
                        </div>
                        <div id="timerError" class="error-message"></div>
                        <textarea id="sessionNotes" class="modern-textarea" placeholder="Session notes..."></textarea>
                    </div>
                    
                    <div id="pomodoro-panel" class="timer-panel hidden">
                        <div class="input-group"><select id="pomodoroCourseSelect" class="modern-select large-text"></select></div>
                        <div class="timer-display-container">
                            <div id="pomodoroTimerDisplay" class="main-timer-text">50:00</div>
                            <div id="pomodoro-status" class="status-badge"></div>
                        </div>
                        <div id="pomodoro-start-controls" class="timer-actions">
                            <button id="pomodoro-start-btn" class="btn btn-primary btn-large">Start Focus</button>
                        </div>
                        <div id="pomodoro-running-controls" class="timer-actions hidden">
                            <button id="pomodoro-pause-resume-btn" class="btn btn-primary">Pause</button>
                            <button id="pomodoro-stop-btn" class="btn btn-danger">Stop</button>
                            <button id="pomodoro-reset-btn" class="btn btn-outline">Reset</button> 
                            <button id="pomodoro-skip-btn" class="btn btn-outline" data-tooltip="Skip current phase">Skip</button>
                        </div>
                        <div id="pomodoroError" class="error-message"></div>
                        <textarea id="pomodoroNotes" class="modern-textarea" placeholder="Session notes..."></textarea>
                    </div>

                    <div id="countdown-panel" class="timer-panel hidden">
                        <div class="input-group"><select id="countdownCourseSelect" class="modern-select large-text"></select></div>
                        <div class="timer-display-container"><div id="countdownTimerDisplay" class="main-timer-text">00:00:00</div></div>
                        <div class="countdown-inputs-row">
                            <div class="time-input-wrapper"><input type="number" id="countdown-hours" min="0" max="23" placeholder="00"><label>HR</label></div>
                            <div class="time-input-wrapper"><input type="number" id="countdown-minutes" min="0" max="59" placeholder="00"><label>MIN</label></div>
                            <div class="time-input-wrapper"><input type="number" id="countdown-seconds" min="0" max="59" placeholder="00"><label>SEC</label></div>
                        </div>
                        <div class="timer-actions">
                            <button id="countdown-start-pause-btn" class="btn btn-primary btn-large">Start</button>
                            <button id="countdown-stop-btn" class="btn btn-danger hidden" disabled>Stop</button>
                            <button id="countdown-reset-btn" class="btn btn-ghost hidden" disabled>Reset</button>
                        </div>
                        <div id="countdownError" class="error-message"></div>
                        <textarea id="countdownNotes" class="modern-textarea" placeholder="Session notes..."></textarea>
                    </div>
                </div>
            </section>

            <div class="tools-stack">
                <section class="card sound-card">
                    <div class="card-header compact-header" style="width:100%; position: absolute; top: 15px; left: 0; padding: 0 20px;">
                        <h3>Focus Audio</h3>
                    </div>
                    <div class="sound-controls">
                        <div class="sound-btn-row">
                            <button id="noise-brown" class="sound-btn" data-tooltip="Deep Focus (Brown Noise)">üåä</button>
                            <button id="noise-pink" class="sound-btn" data-tooltip="Soft Focus (Pink Noise)">üåßÔ∏è</button>
                            <button id="noise-white" class="sound-btn" data-tooltip="Blocker (White Noise)">üì°</button>
                            <button id="noise-stop" class="sound-stop-btn" data-tooltip="Stop Audio">‚èπ</button>
                        </div>
                        <div class="volume-slider-container">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                            <input type="range" id="noise-volume" class="volume-slider" min="0" max="1" step="0.01" value="0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        </div>
                    </div>
                </section>

                <section class="card breathing-card" id="breathing-card-container">
                    <div class="card-header compact-header" style="width:100%; position: absolute; top: 15px; left: 0; padding: 0 20px;">
                        <h3>Box Breathing</h3>
                    </div>
                    <div class="breathing-circle-container" id="breathing-trigger">
                        <div id="visual-container">
                            <div class="orb-layer orb-glow"></div>
                            <div class="orb-layer orb-ring"></div>
                            <div class="orb-layer orb-core"></div>
                        </div>
                    </div>
                    <div id="breathing-label" class="breathing-text">Tap to Center</div>
                    <div class="breathing-footer">
                        <button id="btn-style-toggle" class="style-toggle-btn">Style: Orb</button>
                    </div>
                </section>
            </div>

            <section class="card log-card">
                <div class="card-header">
                    <h3>History</h3>
                    <div class="header-tools">
                        <div class="toggle-pill-container small">
                            <button id="btn-log-chrono" class="toggle-pill active">Time</button>
                            <button id="btn-log-topic" class="toggle-pill">Topic</button>
                        </div>
                        <button id="showAllButton" class="text-link-btn" hidden>Clear Filter</button>
                    </div>
                </div>
                <div id="sessionLog" class="log-list custom-scrollbar"></div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div id="event-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">Add Deadline</h2>
            <div class="input-group"><label>Title</label><input type="text" id="event-text" class="modern-input" placeholder="e.g. Nephro Exam"></div>
            <div class="form-grid">
                <div class="input-group"><label>Due Date</label><input type="text" id="event-date-picker" class="modern-input" placeholder="Required"></div>
                <div class="input-group"><label>Priority</label><select id="event-priority" class="modern-select"><option value="low">Low (Blue)</option><option value="medium">Medium (Orange)</option><option value="high">High (Red)</option></select></div>
            </div>
            <input type="hidden" id="event-timestamp">
            <div id="eventError" class="error-message"></div>
            <div class="modal-footer"><button id="cancel-event-button" class="btn btn-ghost">Cancel</button><button id="save-event-button" class="btn btn-primary">Save</button></div>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Settings</h2>
            <div class="settings-section" style="margin-bottom:15px;">
                <button id="manage-courses-from-settings-btn" class="btn btn-outline" style="width:100%">Manage Courses</button>
            </div>
            
            <div class="settings-section" style="margin-bottom:15px;">
                <label>Alarm (Custom Track)</label>
                <div style="display:flex; gap:10px;">
                    <button id="select-alarm-btn" class="btn btn-outline" style="flex:1;">Select File</button>
                    <button id="test-alarm-btn" class="btn btn-ghost">Test</button>
                </div>
                <span id="selected-alarm-file" style="font-size:0.8rem; color:var(--text-muted); display:block; margin-top:5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Default</span>
            </div>
            
            <div class="settings-section" style="border-top: 1px solid var(--border); padding-top: 15px;">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="input-group"><label style="font-size: 0.9rem; font-weight:600;">Daily Goal (Hours)</label><input type="number" id="setting-heatmap-target" class="modern-input" placeholder="8"></div>
                    <div class="input-group"><label style="font-size: 0.9rem; font-weight:600;">Deadline Lookahead (Days)</label><input type="number" id="deadline-urgency-input" class="modern-input" min="1" max="365"></div>
                </div>
            </div>

            <div class="settings-section" style="margin-top:15px; border-top: 1px solid var(--border); padding-top: 15px;">
                <label style="margin-bottom: 8px; display: block; font-weight: 600; color: var(--text-main);">Pomodoro Timings (Mins)</label>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="input-group"><label style="font-size: 0.75rem;">Focus</label><input type="number" id="setting-focus-duration" class="modern-input"></div>
                    <div class="input-group"><label style="font-size: 0.75rem;">Short Brk</label><input type="number" id="setting-short-break-duration" class="modern-input"></div>
                    <div class="input-group"><label style="font-size: 0.75rem;">Long Brk</label><input type="number" id="setting-long-break-duration" class="modern-input"></div>
                </div>
            </div>

            <div class="settings-section" style="margin-top:15px; border-top: 1px solid var(--border); padding-top: 15px;">
                <label>Backup</label>
                <div style="display:flex; gap:10px;">
                    <button id="export-data-btn" class="btn btn-outline" style="flex:1;">Export</button>
                    <button id="import-data-btn" class="btn btn-outline" style="flex:1;">Import</button>
                </div>
                <input type="file" id="import-file-input" style="display:none" accept=".json">
            </div>

            <div class="settings-section" style="margin-top:15px; border-top: 1px solid var(--border); padding-top: 15px;">
                <label>Account</label>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button id="cloud-auth-btn" class="btn btn-outline" style="width: 100%;">Cloud Login (Sync Memory)</button>
                    <button id="google-logout-btn" class="btn btn-danger" style="width: 100%;">Disconnect Google Calendar</button>
                </div>
            </div>

            <div class="modal-footer">
                <button id="close-settings-modal-btn" class="btn btn-ghost">Cancel</button>
                <button id="save-settings-btn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="pomodoro-prompt-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <h2 id="pomodoro-prompt-title" style="border:none; margin-bottom: 10px;">Phase Complete!</h2>
            <p id="pomodoro-prompt-text" style="color:var(--text-muted); font-size: 1rem; margin-bottom: 25px;"></p>
            <div class="modal-footer" style="justify-content: center; gap: 20px;">
                <button id="pomodoro-prompt-stop-btn" class="btn btn-ghost">Stop Session</button>
                <button id="pomodoro-prompt-confirm-btn" class="btn btn-primary btn-large">Start Next Phase</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-confirm-title">Confirm</h2>
            <p id="modal-confirm-text" style="color:var(--text-muted);"></p>
            <input type="hidden" id="item-to-process">
            <div class="modal-footer">
                <button id="cancel-delete-button" class="btn btn-ghost">Cancel</button>
                <button id="confirm-delete-button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <div id="edit-log-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="edit-modal-title">Edit Entry</h2>
            <input type="hidden" id="edit-timestamp">
            <div class="form-grid">
                <div class="input-group"><label>Date</label><input type="text" id="edit-date-picker" class="modern-input"></div>
                <div class="input-group"><label>Course</label><select id="edit-course-select" class="modern-select"></select></div>
            </div>
            <div id="edit-session-group" class="input-group"><label>Duration</label><input type="text" id="edit-duration" class="modern-input"></div>
            <div id="edit-score-group" class="input-group"><label>Score</label><input type="number" id="edit-score" class="modern-input"></div>
            <div class="input-group"><label>Notes</label><textarea id="edit-notes" class="modern-textarea" rows="3"></textarea></div>
            <div id="editError" class="error-message"></div>
            <div class="modal-footer">
                <button id="cancel-edit-button" class="btn btn-ghost">Cancel</button>
                <button id="save-edit-button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <div id="chart-modal" class="modal-overlay">
        <div class="modal-content chart-modal-content">
            <h2 id="zoomed-chart-title"></h2>
            <div id="zoomed-chart-container"></div>
            <div class="modal-footer">
                <button id="close-chart-modal-button" class="btn btn-ghost">Close</button>
            </div>
        </div>
    </div>

    <div id="courses-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Manage Courses</h2>
            <div class="input-group" style="display:flex; gap:10px;">
                <input type="text" id="new-course-name" class="modern-input" placeholder="New Course">
                <button id="add-course-btn" class="btn btn-primary">Add</button>
            </div>
            <hr style="margin:15px 0; border:0; border-top:1px solid var(--border);">
            <div id="course-list-editor" class="course-list-container custom-scrollbar"></div>
            <div class="modal-footer">
                <button id="close-courses-modal-btn" class="btn btn-ghost">Close</button>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content help-modal-content">
            <h2>User Guide</h2>
            <div id="manual-container" class="manual-container custom-scrollbar"></div>
            <div class="modal-footer">
                <button id="close-help-modal-btn" class="btn btn-primary">Got it</button>
            </div>
        </div>
    </div>
    
    <audio id="alarm-sound"></audio>
    <button id="global-stop-alarm-btn" class="floating-alarm-btn hidden" onclick="document.dispatchEvent(new CustomEvent('stop-alarm'))">
    üîï Stop Alarm
    </button>
    
    <script type="module" src="./renderer-v2.2.26.js"></script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js?v=2.2.26')
                .then((registration) => {
                    console.log('‚úÖ ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch((err) => {
                    console.log('‚ùå ServiceWorker registration failed: ', err);
                });
        });
    }
    </script>
    
</body>
</html>